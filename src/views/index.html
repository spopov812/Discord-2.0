<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link rel="stylesheet" type="text/css" href="../css/index.css">
  </head>

  <body>

    

    <ul class="pages">

      <!-- Chat page -- >
      <li class="chat page">

        <!-- Top banner -->
        <div id="banner">
          <div id="banner-content">
            Welcome to Discord 2.0!
          </div>
          <h2 id="currentRoom"></h2>
        </div>

        <!-- Area for chat -->
        <div class="chatArea">
          <ul id="messages"></ul>
        </div>

        <!-- Active users -->
        <div class="active">
          <h2>Active Users</h2>
          <ul class="users" id="users"></ul>
        </div>

        <!-- Groups -->
        <div class="groupArea">
          <h2>Groups</h2>
          <ul id="groups">
          </ul>
        </div>

        <!-- Chat message entry box -->
        <form action="">
          <input class="inputMessage" id="m" autocomplete="off" placeholder="Type here..." />
        </form>
      </li>
      <!-- Handling user login -->
        <li class="login page" id="usernamePage">
          <div class="nameForm">
            <h3 class="title">What's your nickname?</h3>
            <input class="usernameInput" id="usernameInput" type="text" maxlength="14" placeholder="Username"/>
            <br/>
            <input class="usernameInput" id="passwordInput" type="password" onkeydown="submitLogin()" placeholder="Password" />
          </div>
        </li>
    </ul>
    
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>

      var username
      var socket = io();

      // Creating a name
      function submitLogin() {
        
        if(event.key === 'Enter') {
            
            username = $('#usernameInput').val()

            // Lets server know this users username
            socket.emit('user connect', 
              {
                username : $('#usernameInput').val(),
                password : $('#passwordInput').val()
              }
            )   
        }
      }

      function switchChatroom(chatroomName) {

        console.log(username + " wants to switch to " + chatroomName)

        $('#currentRoom').empty()
        $('#messages').empty()

        // Sets name of current room
        $('#currentRoom').append(chatroomName)

        // Joins the room
        socket.emit('switch room', chatroomName)
      }

      // Valid username/password
      socket.on('valid login', function(info){
          
          // Icon path and options
          base_path = "../assets/"
          options = 'height="50" width="50"'

          // Looping through all the user's chatrooms
          for (var i = 0; i < info['chatrooms'].length; i++) {

            chatroomName = info['chatrooms'][i]
            src = base_path + 'icon.png'

            html = '<img src="' + src + '" ' + options + ' onclick="switchChatroom(this.id)" id="' + chatroomName + '" /><br />'
            console.log("Setting html- " + html)

            // Adding the possible groups to left area
            $('#groups').append($(html).text(chatroomName))
          }

          // Removes login page
          $('#usernamePage').fadeOut('slow')
      })

      // On receiving a chat message
      socket.on('chat message', function(msg){

        $('#messages').append($('<li>').text(msg))
        window.scrollTo(0, document.body.scrollHeight)
      })

      // Users logging in or out
      socket.on('user state update', function(usernames){
        $('#users').empty()

        for (var i = 0; i < usernames.length; i++) {
          $('#users').append($('<li id="' + usernames[i] + '">').text(usernames[i]))
        }
      })



      $(function () {

        // On submitting a chat message
        $('form').submit(function(){
          socket.emit('chat message', 
            {

              username : username,
              message: $('#m').val()

            });
          $('#m').val('')
          return false
        });
      });          
    </script>
  </body>
</html>
